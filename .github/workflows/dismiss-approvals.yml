# generated by o3-pro
name: Auto‑dismiss approvals on real change
on:
  pull_request:
    types: [synchronize]   # fires when new commits pushed

permissions:
  pull-requests: write     # allows review dismissal
  contents: read

jobs:
  recheck:
    runs-on: ubuntu-latest
    steps:
    - name: Decide if commits are “real”
      id: diff
      env:
        BEFORE: ${{ github.event.before }}
        AFTER:  ${{ github.event.after }}
        GH_TOKEN: ${{ secrets.BOT_PAT }}   # PAT with repo scope
      run: |
        # non‑merge commits = parents == 1
        NON_MERGE=$(gh api repos/${{ github.repository }}/compare/$BEFORE...$AFTER \
                    --jq '[.commits[] | select(.parents|length==1)] | length')
        echo "nonmerge=$NON_MERGE" >>"$GITHUB_OUTPUT"

    - name: Dismiss every current approval
      if: steps.diff.outputs.nonmerge != '0'
      env:
        GH_TOKEN: ${{ secrets.BOT_PAT }}
      run: |
        PR=${{ github.event.pull_request.number }}
        gh api repos/${{ github.repository }}/pulls/$PR/reviews \
          --jq '.[] | select(.state=="APPROVED") | .id' | \
        while read RID; do
          gh api -X PUT repos/${{ github.repository }}/pulls/$PR/reviews/$RID/dismissals \
              -f message="New code pushed – review stale"
        done
